<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        .card {
            margin: 0px !important;
            padding: 0px !important;
        }

        .card-title {
            color: white;
            margin: 0 auto;
        }

        .card .card-content {
            border-radius: 0 0 2px 2px!important;
             padding: 15% !important;
        }

        body {
            background: rgba(83,132,154,1);

        }

        .Icons {
            color: rgba(65,191,250,1);
        }

        #BackButton {
            font-size: 24px;
            line-height: 1;
            padding: 12px;
            margin: 0;
        }

            #BackButton a {
                color: white;
            }

        .card-title {
            text-transform: capitalize;
        }
        .collapsible-header {
            background: rgb(11, 17, 20);
            color: white;
            padding: 2%;
        }

        .collapsible,.collapsible-body {
            border:0px;
        }
        .collapsible-body {
         background:rgba(83,132,154,1);
        }

            .collapsible-body label {
                color:white;
            }
    </style>
</head>
<body>
    <div class="col s12 m12">
        <div style="background: rgba(117,117,117,1)" id="LocationButton">
            <div class="white-text" style="width: 100%">
                <h6 id="BackButton"><a href="#/home"><b><</b>&nbsp;&nbsp</a>Tasks</h6>
            </div>
        </div>
    </div>
      <ul class="collapsible" data-collapsible="accordion">     
      
      
      </ul>

</body>

    <script>


        var db = null;
        function formatDate(dateVal) {
                var newDate = new Date(dateVal);

                var sMonth = padValue(newDate.getMonth() + 1);
                var sDay = padValue(newDate.getDate());
                var sYear = newDate.getFullYear();
                var sHour = newDate.getHours();
                var sMinute = padValue(newDate.getMinutes());
                var sSeconds = padValue(newDate.getSeconds());
                var sAMPM = "AM";

                var iHourCheck = parseInt(sHour);

                if (iHourCheck > 12) {
                    sAMPM = "PM";
                    sHour = iHourCheck;
                }
                else if (iHourCheck === 0) {
                    sHour = "12";
                }

                sHour = padValue(sHour);

                return sMonth + "/" + sDay + "/" + sYear + " " + sHour + ":" + sMinute + ":" + sSeconds ;
            }

            function padValue(value) {
                return (value < 10) ? "0" + value : value;
            }

            function ajaxCall(soamessage){
                var url = "https://www.uifsecure.com/UIFSecureWSClient-TEST/UIFequiptracking.asmx?op=SubmitTracking";
                console.log(soamessage);
                $('#LoderImage').show();
                $.support.cors = true;
                $.ajax({
                            type: "POST",
                            url: url,
                            jsonpCallback: "MyCallbackDED",
                            dataType: "xml",
                            processData: false,
                            contentType: "text/xml; charset=\"utf-8\"",
                            data: soamessage,
                            success: function (msg) {
                                $('#LoderImage').hide();
                                var xml = $.parseXML($(msg).text());
                                console.log("IN SUCCESS MESSAGE ");
                                if($(xml).find('SUCCESS')){
                                    console.log(xml);
                                }
                                else {
                                    alert($(msg).text());
                                }
                            },
                            error: function (msg) {
                                alert("Failed try again: " + msg.status + ": " + msg.statusText);
                                $('#LoderImage').hide();
                            }
                        });
            }

        setTimeout(function () {
            db = window.sqlitePlugin.openDatabase({ name: 'demo.db', location: 'default' });
            db.transaction(function (tx) {
                    WorkerType = localStorage.getItem("WorkerType");
                tx.executeSql("SELECT *  from Registration ", [], function (tx, res) {                  
                    var SoaMessage = '<soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope"><soap12:Body><GetWorkerTasksWithSubtasks xmlns="https://www.SmarterASP.NET/UIF"><clientGUID>'+res.rows.item(0).ClientGUID+'</clientGUID><siteGUID>'+res.rows.item(0).SiteGUID+'</siteGUID><workerTypeID>'+WorkerType+'</workerTypeID><equipmentTypeID>ALL</equipmentTypeID></GetWorkerTasksWithSubtasks></soap12:Body></soap12:Envelope>';
                    var url = "https://www.uifsecure.com/UIFSecureWSClient-TEST/UIFequiptracking.asmx?op=GetWorkerTasksWithSubtasks";
                    $('#LoderImage').show();
                    $.support.cors = true;
                    $.ajax({
                        type: "POST",
                        url: url,
                        jsonpCallback: "MyCallbackDED",
                        dataType: "xml",
                        processData: false,
                        contentType: "text/xml; charset=\"utf-8\"",
                        data: SoaMessage,
                        success: function (msg) {
                            var xml = $.parseXML($(msg).text());
                            var Collapse = ''
                            var taskPackage = {};
                            $(xml).find('WorkerTaskPackage WorkerTask').each(function () {
                                Collapse = Collapse + '<li>';
                                Collapse = Collapse + '<div class="collapsible-header">' +
                  '<div id="TaskListButton" style="margin-left:2.5em;">' +
                   '<h5 style="font-size:15px" id="task' + $(this).find('TaskCode').text() + '"  data-TaskEquipmentTypeID="' + $(this).find('EquipmentTypeID').text() + '" data-TaskCode="' + $(this).find('TaskCode').text() + '">' + $(this).find('TaskDesc').text() + '</h5>' +
                   '<form style="display:flex;flex-direction:row">'+
                            '<p><input data-TaskDesc="'+$(this).find('TaskDesc').text()+'" id="mainTaskStart'+ $(this).find('TaskCode').text() + '"  type="checkbox" data-TaskEquipmentTypeID="' + $(this).find('EquipmentTypeID').text() + '"/><label for="mainTaskStart'+$(this).find('TaskCode').text()+'" style="font-size:15px;color:yellow;">Start</label><span style="margin-left:5px;color:white;" id="mainTaskTimeId'+$(this).find('TaskCode').text()+'"></span></p>'+
                            '<p style="margin-left:10px;"><input id="xmainTaskEnd'+ $(this).find('TaskCode').text() + '"  data-TaskDesc="'+$(this).find('TaskDesc').text()+'" type="checkbox" data-TaskEquipmentTypeID="' + $(this).find('EquipmentTypeID').text() + '"/><label for="xmainTaskEnd'+$(this).find('TaskCode').text()+'" style="font-size:15px;color:orange;">Complete</label><span style="margin-left:5px;color:white;" id="xmainTaskCompleteTimeId'+$(this).find('TaskCode').text()+'"></span></p>'+
                    '</form>'+
                   '</div>' +
                   ' </div><div class="collapsible-body" style="margin-left:1em">';
                                if ($(this).find('WorkerSubTask').length != 0) {
                                    $(this).find('WorkerSubTask').each(function () {
                                        if(taskPackage[$(this).parent().find('TaskCode').text()]){
                                            var subTasksList = taskPackage[$(this).parent().find('TaskCode').text()];
                                            subTasksList.push($(this).find('SubTaskCode').text());
                                            taskPackage[$(this).parent().find('TaskCode').text()] = subTasksList;
                                        }
                                        else {
                                            taskPackage[$(this).parent().find('TaskCode').text()] = [$(this).find('SubTaskCode').text()]
                                        }
                                        Collapse = Collapse + '<p class="SubTaskButton">'+
                                                '<label style="font-size:20px;" data-SubTaskCode="' + $(this).find('SubTaskCode').text() + '">' + $(this).find('SubTaskDesc').text() + '</label>'+
                                                '<form style="display:flex;flex-direction:row">'+
                                                '<p><input id="start'+ $(this).find('SubTaskCode').text() + '"  type="checkbox" data-TaskCode="'+$(this).parent().find('TaskCode').text()+'" data-SubTaskDesc="'+$(this).find('SubTaskDesc').text()+'" data-TaskDesc="'+$(this).parent().find('TaskDesc').text()+'"/><label for="start'+$(this).find('SubTaskCode').text()+'" style="font-size:15px;color:yellow;">Start</label><span style="margin-left:5px;color:white;" id="taskTimeId'+$(this).find('SubTaskCode').text()+'"></span></p>'+
                                                '<p style="margin-left:10px;"><input id="end'+ $(this).find('SubTaskCode').text() + '"  type="checkbox" data-TaskCode="'+$(this).parent().find('TaskCode').text()+'" data-SubTaskDesc="'+$(this).find('SubTaskDesc').text()+'" data-TaskDesc="'+$(this).parent().find('TaskDesc').text()+'"/><label for="end'+$(this).find('SubTaskCode').text()+'" style="font-size:15px;color:orange;">Complete</label><span style="margin-left:5px;color:white;" id="taskCompleteTimeId'+$(this).find('SubTaskCode').text()+'"></span></p>'+
                                                '</form>'+
                                            '</p>'
                                    });

                                }
                                Collapse = Collapse + '</div></li>'
                            });
                            console.log('Task Package');
                            console.log(taskPackage);
                            $('.collapsible').html(Collapse);
                            $('.collapsible').collapsible();
                            var checkedList;
                            if (localStorage.getItem("checkedList")){
                                checkedList = localStorage.getItem("checkedList");
                                checkedList = JSON.parse(checkedList);
                                console.log(checkedList);
                                for(let q=0;q<checkedList.length;q++){
                                    $('#'+checkedList[q]["id"]).prop('checked',true);
                                    let idOfTask = checkedList[q]["id"];
                                    if(idOfTask.indexOf("start") !== -1){
                                        if(checkedList[q]["started"]){
                                        var taskTimeIdLS = idOfTask.split("start");
                                        $('#taskTimeId'+taskTimeIdLS[1]).text(checkedList[q]["started"]);
                                    }
                                    }

                                    if(idOfTask.indexOf("mainTaskStart") !== -1){
                                        if(checkedList[q]["started"]){
                                            var mainTaskTimeIdLS = idOfTask.split("mainTaskStart");
                                            $('#mainTaskTimeId'+mainTaskTimeIdLS[1]).text(checkedList[q]["started"]);
                                        }
                                    }

                                    if(idOfTask.indexOf("end")!== -1){
                                        if(checkedList[q]["completed"]) {
                                        var taskCompleteTimeIdLS = checkedList[q]["id"].split("end");
                                        $('#taskCompleteTimeId'+taskCompleteTimeIdLS[1]).text(checkedList[q]["completed"]);
                                    }
                                    }

                                    if(idOfTask.indexOf("xmainTaskEnd") !== -1){
                                        if(checkedList[q]["completed"]){
                                            var mainTaskCompleteTimeIDLS = idOfTask.split("xmainTaskEnd");
                                            console.log("From LS "+checkedList[q]["completed"]);
                                            $('#xmainTaskCompleteTimeId'+mainTaskCompleteTimeIDLS[1]).text(checkedList[q]["completed"]);
                                            // change color of Task
                                            $('#task'+mainTaskCompleteTimeIDLS[1]).css("color","orange");
                                        }
                                    }
                                    
                                }
                            }
                            else {
                                checkedList = [];
                            }

                            $(':checkbox').change(function(){
                                WorkerGUID = localStorage.getItem("WorkerGUID");
                                LocationID = localStorage.getItem("locationID");
                                SiteGUID = localStorage.getItem("SiteGUID");
                                EquipmentGUID = localStorage.getItem("EquipmentGUID");

                                if(this.checked){
                                        if((this.id).indexOf("start") !== -1){
                                            console.log("Start "+this.id);
                                            var taskTimeId = (this.id).split("start");
                                            var dateStart = new Date().toString();
                                            dateStart = formatDate(dateStart);

                                            var mainTaskCodeOfSubTask = $('#'+this.id).attr('data-TaskCode').trim();
                                            var mainTaskOfSubTaskDesc = $('#'+this.id).attr('data-TaskDesc').trim();
                                            var subTaskDesc = $('#'+this.id).attr('data-SubTaskDesc').trim();
                                            var mainTaskEquipmentTypeID = $('#mainTaskStart'+mainTaskCodeOfSubTask).attr('data-TaskEquipmentTypeID').trim();
                                            console.log('mainTaskCodeOfSubTask '+mainTaskCodeOfSubTask);
                                            console.log('mainTaskOfSubTaskDesc '+mainTaskOfSubTaskDesc);
                                            console.log('mainTaskCode From LS '+localStorage.getItem('CurrentTaskId'));
                                            if(localStorage.getItem('CurrentTaskId')){
                                                if(mainTaskCodeOfSubTask === localStorage.getItem('CurrentTaskId')){
                                                    if($('#xmainTaskEnd'+mainTaskCodeOfSubTask).is(":checked")){
                                                        alert("Uncheck completed task to start the subtask");
                                                        $('#start'+taskTimeId[1]).prop('checked',false);
                                                    }
                                                    else{
                                                        // start the task
                                                    $('#taskTimeId'+taskTimeId[1]).text(dateStart);
                                                    checkedList.push({id:this.id,started:dateStart,mainTaskId:mainTaskCodeOfSubTask,taskId:taskTimeId[1]});
                                                    localStorage.setItem("checkedList",JSON.stringify(checkedList));
                                                    var currentTaskStartDate = localStorage.getItem("CurrentTaskStartDate");
                                                    var soamessage1 = '<soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">'+'<soap12:Body>'+'<SubmitTracking xmlns="https://www.SmarterASP.NET/UIF">'+'<PackageXML>'+'&lt;Metrics WorkerGUID=&quot;'+WorkerGUID.trim()+'&quot; SiteGUID=&quot;'+SiteGUID.trim()+'&quot; EquipmentGUID=&quot;'+EquipmentGUID.trim()+'&quot; SendTime=&quot;'+dateStart.trim()+'&quot; &gt;'+'&lt;WorkerTask  EquipmentTypeID=&quot;'+mainTaskEquipmentTypeID.trim()+'&quot; Comments="" EndDate="" StartDate=&quot;'+currentTaskStartDate.trim()+'&quot; TaskDesc=&quot;'+mainTaskOfSubTaskDesc.trim()+'&quot; TaskCode=&quot;'+mainTaskCodeOfSubTask.trim()+'&quot; WorkerGUID= &quot;'+WorkerGUID.trim()+'&quot;  LocationID= &quot;'+LocationID.trim()+'&quot; &gt;'+'&lt;WorkerSubTask  EquipmentGUID=&quot;'+EquipmentGUID.trim()+'&quot; Comments="" EndDate="" StartDate=&quot;'+dateStart.trim()+'&quot; SubTaskDesc=&quot;'+subTaskDesc.trim()+'&quot; SubTaskCode=&quot;'+taskTimeId[1].trim()+'&quot;&gt;'+'&lt;/WorkerSubTask &gt;'+'&lt;/WorkerTask &gt;'+'&lt;/Metrics &gt;'+'</PackageXML>'+'</SubmitTracking>'+'</soap12:Body>'+'</soap12:Envelope>';
                                                    console.log("SUBTASK STARTED");
                                                    ajaxCall(soamessage1);
                                                    }
                                                }
                                                else {
                                                    alert("Please complete the existing main task first");
                                                    $('#start'+taskTimeId[1]).prop('checked',false);
                                                }
                                            }
                                            else {
                                                alert("Please start the main task first");
                                                $('#start'+taskTimeId[1]).prop('checked',false);
                                            }
                                            
                                            // subtask is started
                                            
                                        }
                    
                                        if((this.id).indexOf("end") !== -1){
                                            console.log("End "+this.id);
                                            var taskCompleteTimeId = (this.id).split("end");
                                            if($('#start'+taskCompleteTimeId[1]).is(":checked")){
                                                var dateComplete = new Date().toString();
                                                dateComplete = formatDate(dateComplete);
                                                
                                                var mainTaskCodeOfSubTask = $('#'+this.id).attr('data-TaskCode').trim();
                                                var mainTaskOfSubTaskDesc = $('#'+this.id).attr('data-TaskDesc').trim();
                                                var subTaskDesc = $('#'+this.id).attr('data-SubTaskDesc').trim();
                                                var currentTaskStartDate = localStorage.getItem("CurrentTaskStartDate");
                                                var mainTaskEquipmentTypeID = $('#mainTaskStart'+mainTaskCodeOfSubTask).attr('data-TaskEquipmentTypeID').trim();
                                                $('#taskCompleteTimeId'+taskCompleteTimeId[1]).text(dateComplete);

                                                // get start time from checklist
                                                var checkIndex = checkedList.findIndex(i=> i.taskId === taskCompleteTimeId[1]);
                                                var startTimeFromStorage = checkedList[checkIndex]["started"];
                                                checkedList.push({id:this.id,completed:dateComplete,mainTaskId:mainTaskCodeOfSubTask,taskId:taskCompleteTimeId[1]});
                                                localStorage.setItem("checkedList",JSON.stringify(checkedList));

                                                var soamessage1 = '<soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">'+'<soap12:Body>'+'<SubmitTracking xmlns="https://www.SmarterASP.NET/UIF">'+'<PackageXML>'+'&lt;Metrics WorkerGUID="'+WorkerGUID.trim()+'" SiteGUID="'+SiteGUID.trim()+'" EquipmentGUID="'+EquipmentGUID.trim()+'" SendTime="'+dateComplete.trim()+'" &gt;'+'&lt;WorkerTask  EquipmentTypeID="'+mainTaskEquipmentTypeID.trim()+'" Comments="" EndDate="" StartDate="'+currentTaskStartDate.trim()+'" TaskDesc="'+mainTaskOfSubTaskDesc.trim()+'" TaskCode="'+mainTaskCodeOfSubTask.trim()+'" WorkerGUID="'+WorkerGUID.trim()+'" LocationID="'+LocationID.trim()+'" &gt;'+'&lt;WorkerSubTask  EquipmentGUID="'+EquipmentGUID.trim()+'" Comments="" EndDate="'+dateComplete.trim()+'" StartDate="'+startTimeFromStorage.trim()+'" SubTaskDesc="'+subTaskDesc.trim()+'" SubTaskCode="'+taskCompleteTimeId[1].trim()+'" &gt;'+'&lt;/WorkerSubTask &gt;'+'&lt;/WorkerTask &gt;'+'&lt;/Metrics &gt;'+'</PackageXML>'+'</SubmitTracking>'+'</soap12:Body>'+'</soap12:Envelope>';
                                                //subtask is ended
                                                console.log("SUBTASK ENDED");
                                                ajaxCall(soamessage1);
                                            }
                                            else {
                                                alert("Please start the task first");
                                                $('#end'+taskCompleteTimeId[1]).prop('checked',false);
                                            }
                                        }
                                        if((this.id).indexOf("mainTaskStart") !== -1){
                                            console.log("mainTaskStart "+this.id);
                                            var mainTaskStartTimeId = (this.id).split("mainTaskStart");
                                            var mainTaskDateStart = new Date().toString();
                                            mainTaskDateStart = formatDate(mainTaskDateStart).trim();
                                            var mainTaskEquipmentTypeID = $('#'+this.id).attr('data-TaskEquipmentTypeID').trim();
                                            var mainTaskDesc = $('#'+this.id).attr('data-TaskDesc').trim();
                                            $('#mainTaskTimeId'+mainTaskStartTimeId[1]).text(mainTaskDateStart);
                                            checkedList.push({id:this.id, started:mainTaskDateStart});
                                            localStorage.setItem("checkedList",JSON.stringify(checkedList));
                                            localStorage.setItem("CurrentTaskStartDate",mainTaskDateStart);
                                            localStorage.setItem("CurrentTaskId",mainTaskStartTimeId[1]);
                                            console.log("Data-TaskDesc "+$('#'+this.id).attr('data-TaskDesc'));
                                            localStorage.setItem("CurrentTaskDesc",$('#'+this.id).attr('data-TaskDesc'));

                                            var soamessage1 = '<soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">'+'<soap12:Body>'+'<SubmitTracking xmlns="https://www.SmarterASP.NET/UIF">'+'<PackageXML>'+'&lt;Metrics WorkerGUID="'+WorkerGUID.trim()+'" SiteGUID="'+SiteGUID.trim()+'" EquipmentGUID="'+EquipmentGUID.trim()+'" SendTime="'+mainTaskDateStart.trim()+'" &gt;'+'&lt;WorkerTask  EquipmentTypeID="'+mainTaskEquipmentTypeID.trim()+'" Comments="" EndDate="" StartDate="'+mainTaskDateStart.trim()+'" TaskDesc="'+mainTaskDesc.trim()+'" TaskCode="'+mainTaskStartTimeId[1].trim()+'" WorkerGUID="'+WorkerGUID.trim()+'"  LocationID="'+LocationID.trim()+'" &gt;' +'&lt;/WorkerTask &gt;' +'&lt;/Metrics &gt;' +'</PackageXML>' +'</SubmitTracking>'+'</soap12:Body>'+'</soap12:Envelope>';
                                            //main task is started
                                            console.log("MAIN TASK STARTED");
                                            ajaxCall(soamessage1);
                                        }

                                        if((this.id).indexOf("xmainTaskEnd") !== -1){
                                            // start all subtasks, end all subtasks.
                                            console.log("mainTaskEnd"+ this.id);
                                            var mainTaskCompleteTimeId = (this.id).split("xmainTaskEnd");
                                            if($('#mainTaskStart'+mainTaskCompleteTimeId[1]).is(":checked")){
                                                var mainTaskDateStart = new Date().toString();
                                                mainTaskDateStart = formatDate(mainTaskDateStart).trim();

                                                var mainTaskDateComplete = new Date();
                                                mainTaskDateComplete.setSeconds(mainTaskDateComplete.getSeconds()+2);
                                                mainTaskDateComplete.toString();
                                                mainTaskDateComplete = formatDate(mainTaskDateComplete).trim();

                                                $('#xmainTaskCompleteTimeId'+mainTaskCompleteTimeId[1]).text(mainTaskDateComplete);

                                                var mainTaskEquipmentTypeID = $('#'+this.id).attr('data-TaskEquipmentTypeID').trim();
                                                var mainTaskDesc = $('#'+this.id).attr('data-TaskDesc').trim();
                                                checkedList.push({id:this.id,completed:mainTaskDateComplete});

                                                $('#task'+mainTaskCompleteTimeId[1]).css("color","orange");

                                                localStorage.setItem("checkedList",JSON.stringify(checkedList));
                                                var currentTaskStartDate = localStorage.getItem('CurrentTaskStartDate');
                                                localStorage.setItem("CurrentTaskEndDate",mainTaskDateComplete);
                                                //main task is ended
                                                var allSubTasksString = '';
                                                var subTasksOfTaskList = taskPackage[mainTaskCompleteTimeId[1]];
                                                for(var b=0;b<subTasksOfTaskList.length;b++){
                                                    var startedTime;
                                                    var endedTime;
                                                    var subTaskCodeFromList = subTasksOfTaskList[b];
                                                    var checkIndexStart = checkedList.findIndex(i=> i.id === 'start'+subTaskCodeFromList);
                                                    if(checkIndexStart>-1){
                                                        startedTime = checkedList[checkIndexStart]["started"];
                                                        var checkIndexEnd = checkedList.findIndex(i=> i.id === 'end'+subTaskCodeFromList);
                                                        if(checkIndexEnd>-1){
                                                            endedTime = checkedList[checkIndexEnd]["completed"];
                                                        }
                                                        else {
                                                            endedTime = mainTaskDateComplete;
                                                        }
                                                        var subTaskDesc = $('#start'+subTaskCodeFromList).attr('data-SubTaskDesc').trim();
                                                        allSubTasksString = allSubTasksString+'&lt;WorkerSubTask  EquipmentGUID="'+EquipmentGUID.trim()+'" Comments="" EndDate="'+endedTime+'" StartDate="'+startedTime+'" SubTaskDesc="'+subTaskDesc.trim()+'" SubTaskCode="'+subTaskCodeFromList.trim()+'" &gt;'+'&lt;/WorkerSubTask &gt;'
                                                        // check all the items
                                                        $('#start'+subTaskCodeFromList).prop('checked',true);
                                                        $('#end'+subTaskCodeFromList).prop('checked',true);
                                                        $('#taskTimeId'+subTaskCodeFromList).text(startedTime);
                                                        $('#taskCompleteTimeId'+subTaskCodeFromList).text(endedTime);
                                                        // push to checked list
                                                        checkedList.push({id:'end'+subTaskCodeFromList,completed:endedTime,mainTaskId:mainTaskCompleteTimeId[1],taskId:subTaskCodeFromList});
                                                        checkedList.push({id:'start'+subTaskCodeFromList,started:startedTime,mainTaskId:mainTaskCompleteTimeId[1],taskId:subTaskCodeFromList});
                                                    }
                                                }
                                                localStorage.setItem("checkedList",JSON.stringify(checkedList));

                                                var soamessage1 = '<soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">'+'<soap12:Body>'+'<SubmitTracking xmlns="https://www.SmarterASP.NET/UIF">'+'<PackageXML>'+'&lt;Metrics WorkerGUID="'+WorkerGUID.trim()+'" SiteGUID="'+SiteGUID.trim()+'" EquipmentGUID="'+EquipmentGUID.trim()+'" SendTime="'+mainTaskDateComplete.trim()+'" &gt;'+'&lt;WorkerTask  EquipmentTypeID="'+mainTaskEquipmentTypeID.trim()+'" Comments="" EndDate="'+mainTaskDateComplete.trim()+'" StartDate="'+currentTaskStartDate.trim()+'" TaskDesc="'+mainTaskDesc.trim()+'" TaskCode="'+mainTaskCompleteTimeId[1].trim()+'" WorkerGUID="'+WorkerGUID.trim()+'"  LocationID="'+LocationID.trim()+'" &gt;'+allSubTasksString+'&lt;/WorkerTask &gt;'+'&lt;/Metrics &gt;' +'</PackageXML>' +'</SubmitTracking>' +'</soap12:Body>'+'</soap12:Envelope>';
                                            //main task is started
                                            console.log("MAIN TASK ENDED");
                                            ajaxCall(soamessage1);

                                            }
                                            else {
                                                alert("Please start the task first");
                                                $('#xmainTaskEnd'+mainTaskCompleteTimeId[1]).prop('checked',false);
                                            }

                                        }
                                }
                                else {
                                    //remove from checked list
                                    // var checkIndex = checkedList.indexOf(this.id);
                                    var checkIndex = checkedList.findIndex(i=> i.id === this.id);
                                    if(checkIndex > -1){
                                        // checkedList.splice(checkIndex,1);
                                        if((this.id).indexOf("start") !== -1){
                                            var taskTimeIdRemove = (this.id).split("start");
                                            // $('#taskTimeId'+taskTimeIdRemove[1]).text("");
                                            $('#start'+taskTimeIdRemove[1]).prop('checked',true);
                                            // $('#taskCompleteTimeId'+taskTimeIdRemove[1]).text("");
                                            alert("Can't uncheck Start");
                                        }

                                        if((this.id).indexOf("end") !== -1){
                                            checkedList.splice(checkIndex,1);
                                            var taskCompleteTimeIdRemove = (this.id).split("end");
                                            $('#end'+taskCompleteTimeIdRemove[1]).prop('checked',false);
                                            $('#taskCompleteTimeId'+taskCompleteTimeIdRemove[1]).text("");
                                        }

                                        if((this.id).indexOf("mainTaskStart") !== -1){
                                            var mainTaskTimeIdRemove = (this.id).split("mainTaskStart");
                                            // $('#mainTaskTimeId'+mainTaskTimeIdRemove[1]).text("");
                                            $('#mainTaskStart'+mainTaskTimeIdRemove[1]).prop('checked',true);
                                            // $('#xmainTaskCompleteTimeId'+mainTaskTimeIdRemove[1]).text("");
                                            // $('#task'+mainTaskTimeIdRemove[1]).css("color","white");
                                            alert("Can't uncheck Start");
                                        }

                                        if((this.id).indexOf("xmainTaskEnd") !== -1){
                                            checkedList.splice(checkIndex,1);
                                            var mainTaskCompleteTimeIdRemove = (this.id).split("mainTaskEnd");
                                            $('#xmainTaskEnd'+mainTaskCompleteTimeIdRemove[1]).prop('checked',false);
                                            $('#xmainTaskCompleteTimeId'+mainTaskCompleteTimeIdRemove[1]).text("");
                                            $('#task'+mainTaskCompleteTimeIdRemove[1]).css("color","white");
                                        }

                                        localStorage.setItem("checkedList",JSON.stringify(checkedList));
                                    }
                                }
                            });

                            // var longpress;
                            $(".SubTaskButton").on('click', function () {                               
                                // longpress = true;
                                subTaskCode = $(this).find('label').attr('data-SubTaskCode');
                                subTaskDesc = $(this).find('label').text();
                                TaskDesc = $(this).parent().parent().find('h5').text();
                                localStorage.setItem("TaskDesc",TaskDesc);
                                TaskCode = $(this).parent().parent().find('h5').attr('data-TaskCode');
                                localStorage.setItem("SubTaskCode",subTaskCode);
                                EquipmentTypeID = $(this).parent().parent().find('h5').attr('data-TaskEquipmentTypeID');
                                // setTimeout(function () {
                                //     if (longpress) {                                       
                                //         window.location.href = "#/ReportTask";
                                //     }
                                // }, 3000);
                                window.location.href = "#/ReportTask";
                            })
                            // $(".SubTaskButton").on('touchend', function () {
                            //     longpress = false;
                            // })
                        },
                        complete: function () {
                            $('#LoderImage').hide();
                        },
                        error: function (msg) {
                            alert("Failed: " + msg.status + ": " + msg.statusText);
                        }

                    });

                });
            });
        }, 500);



    </script>
</html>

