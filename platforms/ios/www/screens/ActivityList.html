<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        .card {
            margin: 0px !important;
            padding: 0px !important;
        }

        .card-title {
            color: white;
            margin: 0 auto;
        }

        .card .card-content {
            border-radius: 0 0 0px 0px!important;
            padding: 15% !important;
        }

        body {
            background: rgba(83,132,154,1);
        }

        .Icons {
            color: rgba(65,191,250,1);
        }

        .BackButtonText {
            font-size: 20px;
            line-height: 1;
            padding: 10px;
            margin: 0;
        }

            .BackButtonText a {
                color: white;
            }

        .card-title {
            text-transform: capitalize;
        }

        .collapsible-body {
            background: rgba(83,132,154,1);
        }
    </style>
</head>
<body>
    <div class="col s12 m12">
        <div style="background: rgba(117,117,117,1)" id="LocationButton">
            <div class="white-text" style="display:flex;flex-direction:row;width: 100%" id="ActivityListClass">
                <h6 class="BackButtonText" id="BackButton"><a href="#/ActivityorDelay"><b><</b>&nbsp;&nbsp</a><span id="ActivityHeading"></span></h6>
            </div>
        </div>
    </div>

    <div class="col s12" style="background-color:rgba(83,132,154,1);padding:5px" id="checkContainer">
    
   
    </div>
   
</body>

<script>
    $(document).ready(function () {
        $('#ActivityHeading').html($('#ActivityTypeHiddenTextBox').val() + ' List');
        var HTMLgen = "";
        var CategoryIDDict = {};
        // get all categoryIDs in an array
        console.log(ActData);
        $.each(ActData, function (index, item) {
            var catergoryIDKeys = Object.keys(CategoryIDDict);
            if(item.CategoryID in catergoryIDKeys){
            }
            else {
                CategoryIDDict[item.CategoryID] = [];
            }
        });

        console.log(CategoryIDDict);

        $.each(ActData, function (index, item) {
            // if parentID is there = push to that categoryID
            if(item.ParentID){
                console.log("ParentID "+item.ParentID);
                CategoryIDDict[item.ParentID].push(item);
            }
            else {
                CategoryIDDict[item.CategoryID].push(item);
            }
        });

        console.log(CategoryIDDict);
        function formatDate(dateVal) {
                var newDate = new Date(dateVal);

                var sMonth = padValue(newDate.getMonth() + 1);
                var sDay = padValue(newDate.getDate());
                var sYear = newDate.getFullYear();
                var sHour = newDate.getHours();
                var sMinute = padValue(newDate.getMinutes());
                var sSeconds = padValue(newDate.getSeconds());
                var sAMPM = "AM";

                var iHourCheck = parseInt(sHour);

                if (iHourCheck > 12) {
                    sAMPM = "PM";
                    sHour = iHourCheck - 12;
                }
                else if (iHourCheck === 0) {
                    sHour = "12";
                }

                sHour = padValue(sHour);

                return sMonth + "/" + sDay + "/" + sYear + " " + sHour + ":" + sMinute + ":" + sSeconds ;
            }

            function padValue(value) {
                return (value < 10) ? "0" + value : value;
            }
        // geolocation onSuccess and onError
        function onGeolocationSuccess(position){
            // get all required data from position

            var activityItemToSend = localStorage.getItem("ActivityItem");
            var dateToSend = new Date().toString();
            dateToSend = formatDate(dateToSend);

            // api call
            var SiteGUIDToSend = localStorage.getItem("SiteGUID");
            var EquipmentGUIDToSend = localStorage.getItem("EquipmentGUID");
            var WorkerGUIDToSend = localStorage.getItem("WorkerGUID");

            // var SoaMessage2 = '<soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope"><soap12:Body><SubmitTracking xmlns="https://www.SmarterASP.NET/UIF"><PackageXML>'+'&lt;Metrics WorkerGUID= &quot;'+WorkerGUIDToSend+' &quot; SiteGUID=&quot;'+SiteGUIDToSend+'&quot; EquipmentGUID=&quot;'+EquipmentGUIDToSend+'&quot; SendTime=&quot;'+dateToSend+'&quot;&gt; &lt;Message Text=&quot;'+$('#messageText').val()+'&quot; TimeStamp=&quot;'+dateToSend+'&quot; Destination=&quot;'+DestEqGUID+'&quot;&gt; &lt;/Message&gt; &lt;/Metrics&gt; '+'</PackageXML></SubmitTracking></soap12:Body></soap12:Envelope>';
            //         var url2 = "https://www.uifsecure.com/UIFSecureWSClient-TEST/UIFequiptracking.asmx?op=SubmitTracking";
            //         $('#LoderImage').show();
            //         $.support.cors = true;
            //         $.ajax({
            //             type: "POST",
            //             url: url2,
            //             jsonpCallback: "MyCallbackDED",
            //             dataType: "xml",
            //             processData: false,
            //             contentType: "text/xml; charset=\"utf-8\"",
            //             data: SoaMessage2,
            //             success: function (msg) {
            //                 alert($(msg).text());
            //                 var xml2 = $.parseXML($(msg).text());
            //             },
            //             complete:function(){
            //                 $('#LoderImage').hide();
            //             },
            //             error: function (msg) {
            //                 alert("Failed: " + msg.status + ": " + msg.statusText);
            //             }
            //         });
        }

        function onGeolocationError(error){
            alert("Error"+JSON.stringify(error));
        }

        // var activityArray = [];
        // $.each(ActData, function (index, item) {   
        //     activityArray.push(item.CategoryID+index);        
        //     // HTMLgen=HTMLgen+' <p style="padding:3px"> <input type="checkbox" style="border-color:white" id="'+item.CategoryID+index+'" data-equipid="'+item.EquipmentOrWorkerTypeID+'" />';
        //     HTMLgen = HTMLgen + '<p style="color:white;font-size:2em;" id="' + item.CategoryID +index+ '" data-catID="' + item.CategoryID +index+ '" data-categoryID="' + item.CategoryID +'">' + item.CategoryName + '</p>';           
        // });
        // $('#checkContainer').html(HTMLgen);

        var categoryIDArray = Object.keys(CategoryIDDict);
        for(var k=0;k<categoryIDArray.length;k++){
            if(CategoryIDDict[categoryIDArray[k]].length>0){
                var objectsOfCategoryID = CategoryIDDict[categoryIDArray[k]];
                console.log("---objectsOfCategoryID--");
                console.log(objectsOfCategoryID);
                var result = objectsOfCategoryID.filter(function(obj){
                    return obj.CategoryID == categoryIDArray[k];
                });
                console.log("---RESULT----");
                console.log(result);
                HTMLgen = HTMLgen + '<p style="color:white;font-size:2em;" id="' + result[0].CategoryID +'" data-categoryID="' + result[0].CategoryID +'">' + result[0].CategoryName + '</p>';
                
            }
        }
        $('#checkContainer').html(HTMLgen);

        var selectedCategoryIDArray = [];
        $('#checkContainer').find('p').click(function(){
            var selectedCategoryID = $(this).attr('data-categoryID')
            console.log("CLICKED "+selectedCategoryID);
            selectedCategoryIDArray.push(selectedCategoryID);

            var parentName = $(this).text();
            localStorage.setItem("ActivityItem",$(this).text());
            //replace checkContainer With new list
            var subCategoriesArray = CategoryIDDict[selectedCategoryID];
            if(subCategoriesArray.length>0){
                // if they have more subcategories
                var subHTMLgen = "";
                for(var j=0;j<subCategoriesArray.length;j++){
                    if(subCategoriesArray[j]["CategoryID"]!== selectedCategoryID){
                        //get categoryName and generate new html
                        var subCategoryName = subCategoriesArray[j]["CategoryName"];
                        var subCategoryParentID = subCategoriesArray[j]["ParentID"];
                        subHTMLgen = subHTMLgen+ '<div><p style="color:white;font-size:2em;" id="' + subCategoriesArray[j]["CategoryID"] +'" data-catID="' + subCategoriesArray[j]["CategoryID"] +'" data-categoryID="' + subCategoriesArray[j]["CategoryID"] +'" data-parentID="' + subCategoryParentID +'">' + subCategoryName + '</p><button onclick='+function(){alert("Hello")};+';>Select</button></div>';
                    }
                }
                $('#ActivityListClass').append('<h6 class="BackButtonText" id="BackButton'+$(this).attr('data-categoryID')+'"><a href="#/ActivityorDelay"><b><</b>&nbsp;&nbsp</a><span>'+parentName+'</span></h6>');
                $('#checkContainer').html(subHTMLgen);
            }
            else {
                console.log("No sub categories --- selectedCategoryIDArray");
                console.log(selectedCategoryIDArray);
                // if they don't have any more sub categories
                for(var l=0;l<categoryIDArray.length;l++){
                    if(categoryIDArray[l] in selectedCategoryIDArray){
                        $('#'+categoryIDArray[l]).css("color","yellow");
                    }
                    else {
                        $('#'+categoryIDArray[l]).css("color","white"); 
                    }
                }

            }
            // start sending geolocation.
            // setInterval(function(){
            //     navigator.geolocation.getCurrentPosition(onGeolocationSuccess, onGeolocationError);
            // },10000);

        });
    });
</script>
</html>
